{% extends 'template/jhTemplateV4.html'%}

{% block vueTemplate %}
<script type="text/html" id="app-template">
<div>
  <v-app mobile-breakpoint="sm">
    <jh-menu />
    <v-container class="mt-15 px-10">
      <div>
        <v-row class="ma-0 align-center flex-none pa-0" class="pa-2" align="center" style="height: 100%;">
          <v-col>
            <div class="mt-4 text-subtitle-1">
              【{{ title }}】的作业设计
              <span style="font-size: 1rem;" class="sm-hide">(ID: {{ assignmentId }})</span>
            </div>
            <v-breadcrumbs class="pb-3 pt-0 px-0" :items="breadcrumbs" divider="-"></v-breadcrumbs>
          </v-col>

          <v-col class="d-flex sm-pt-2 sm-pl-0 md-pr-0 justify-end">
            <v-btn color="success" dark class="elevation-0 mr-2" v-if="assignment && assignment.assignmentSubmitStatus !== 'publish'" @click="doUiAction('saveArticleAssignment', false)">保存</v-btn>
            <v-btn color="error" dark class="elevation-0 mr-2" v-if="assignment && assignment.assignmentSubmitStatus !== 'publish'" @click="doUiAction('saveArticleAssignment', 'publish')">提交</v-btn>
            <div v-else>
              <v-btn color="error" dark class="elevation-0 mr-2" disabled >已提交，不能修改</v-btn>
              <v-btn color="success" dark class="elevation-0 mr-2" @click="doUiAction('saveArticleAssignment', 'cancel')">撤销提交</v-btn>
            </div>
          </v-col>
        </v-row>
      </div>
      <div style="height: calc(100vh - 300px)">
        <form-item-list-generator
        :form-item-list="assignmentStandardAnswer"
        :selected-form-item-id="selectedFormItemId"
        @change="doUiAction('updateFormItemList', $event)"
        ref="formItemListGenerator"/>
      </div>
    </v-container>
  </v-app>

  <jh-toast />
  <jh-mask />
  <jh-confirm-dialog />
</div>
</script>

<div id="app">
</div>
{% endblock %}

{% block vueScript %}
<!-- 引入额外的库文件 >>>>>>>>>>>>> -->
<link rel="stylesheet" href="/<$ ctx.app.config.appId $>/public/plugins/editor.md/css/editormd.min.css" />
<script src="/<$ ctx.app.config.appId $>/public/js/lib/jquery.min.js"></script>
<script src="/<$ ctx.app.config.appId $>/public/plugins/editor.md/editormd.js"></script>
<script src="/<$ ctx.app.config.appId $>/public/js/lib/Sortable.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>
<!-- <<<<<<<<<<<<< 引入额外的库文件 -->

<!-- 加载页面组件 >>>>>>>>>>>>> -->
{% include 'component/formItemMarkdown.html' %}
{% include 'component/formItemListContent.html' %}
{% include 'component/formItemListGenerator.html' %}
<!-- <<<<<<<<<<<<< 加载页面组件 -->

<script type="module">
  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    data: () => ({
      selectedFormItemId: '',
      optionKey: {
        0: "A",
        1: "B",
        2: "C",
        3: "D",
        4: "E",
        5: "F",
        6: "G",
        7: "H",
        8: "I",
        9: "J",
        10: "K",
      },
      breadcrumbs: [
        {
          text: '文章管理',
          disabled: true,
        },
        {
          text: '作业设计',
          disabled: true,
        }
      ],

      assignmentId: null,
      assignment: null,
      title: null,
      saveActionData: {},
      assignmentStandardAnswer: [],
      codemirrorOptions: {
        mode: 'application/json',
        theme: 'material-darker',
        indentUnit: 4,
        smartIndent: false,
        tabSize: 4,
        indentWithTabs: true,
      },

    }),
    watch: {
      assignmentStandardAnswer: {
        deep: true,
        handler() {
          this.buildFormItemList();
        }
      },
    },
    async created() {
      const urlParams = new URLSearchParams(location.search);
      const assignmentId = urlParams.get('assignmentId');
      const title = urlParams.get('title');
      if (assignmentId) {
        this.assignmentId = assignmentId;
      }
      if (title) {
        this.title = title;
      }
      this.doUiAction('getAssignment', assignmentId);
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'getAssignment':
            await this.getAssignment(uiActionData);
            await this.buildassignmentStandardAnswer(uiActionData);
            break;
          case 'saveArticleAssignment':
            await this.vaildArticleAssignment(uiActionData);
            await this.buildAssignmentItemFile(uiActionData);
            await this.createSaveActionData(uiActionData);
            await this.saveArticleAssignmentRequest(uiActionData);
            await this.resetAssignmentSubmitStatus(uiActionData);
            break;
          case 'updateFormItemList':
            await this.updateFormItemList(uiActionData);
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      buildFormItemList() {
        let list = []
        if (this.assignmentStandardAnswer) {
          list = _.cloneDeep(this.assignmentStandardAnswer);
          list.forEach(item => {
            // delete item.answerData;
            item.userData = {};
          })
        }
        return list;
      },
      // ---------- 初始化作业详情 >>>>>>>>>>>>> ----------
      async getAssignment(assignmentId) {
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'designAssignment',
              actionId: 'selectAssignment',
              where: { assignmentId: this.assignmentId }
            }
          }
        });

        if (result.data.appData.resultData.rows.length < 1) {
          window.vtoast.fail("文章不存在");
          return;
        }

        this.assignment = result.data.appData.resultData.rows[0];
      },

      buildassignmentStandardAnswer() {
        const assignmentStandardAnswer = JSON.parse(this.assignment.assignmentStandardAnswer || '[]');
        _.forEach(assignmentStandardAnswer, (item, index) => {
          if (!item.hasOwnProperty('upload')) {
            item.upload = [];
          }
          if (!item.hasOwnProperty('file')) {
            item.file = {};
          }
        })
        this.assignmentStandardAnswer = assignmentStandardAnswer;
      },
      // ---------- <<<<<<<<<<<<< 初始化作业详情 ----------


      // ---------- 保存作业 uiAction >>>>>>>>>>>>> ----------
      // 核验作业状态
      async vaildArticleAssignment(assignmentSubmitStatus) {
        if (!this.assignment) {
          window.vtoast.fail("文章不存在");
          throw new Error("[saveArticleAssignment：文章不存在]")
        }

        if (assignmentSubmitStatus === 'publish' && !await window.confirmDialog({ title: '提交后请勿再次修改保存', content: '确定提交吗？' })) {
          throw new Error("[saveArticleAssignment:confirmDialog：提交后请勿再次修改保存,确定提交吗], 否")
        }
      },
      buildAssignmentItemFile() {
        _.forEach(this.assignmentStandardAnswer, (item, index) => {
          item.file = {}
          _.forEach(item.upload, (type, i) => {
            item.file[type] = '';
          })
        })
      },
      createSaveActionData(assignmentSubmitStatus) {
        this.saveActionData = {};
        const articleAssignment = _.cloneDeep(this.assignmentStandardAnswer);
        let assignmentFullMarks = 0;
        articleAssignment.forEach(formItem => {
          formItem.answerData = {};
          assignmentFullMarks += Number(formItem.component.score || 0)
          if (formItem.component.type == 'questionGroup') {
            formItem.component.itemList.forEach(childFormItem=> {
              assignmentFullMarks += Number(childFormItem.component.score || 0)
            })
          }
        })
        this.saveActionData = {
          assignmentStandardAnswer: JSON.stringify(this.assignmentStandardAnswer),
          assignmentFullMarks
        };
        if (assignmentSubmitStatus === 'publish') {
          this.saveActionData.assignmentSubmitStatus = assignmentSubmitStatus;
        }
        if (assignmentSubmitStatus === 'cancel') {
          this.saveActionData.assignmentSubmitStatus = null;
        }
      },
      countAssignmentFullMarks() {

      },
      async saveArticleAssignmentRequest(assignmentSubmitStatus) {
        window.vtoast.loading("保存");
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'designAssignment',
              actionId: 'updateAssignment',
              actionData: this.saveActionData,
              where: { assignmentId: this.assignmentId }
            }
          }
        });
        const msg = assignmentSubmitStatus === 'publish' ? '提交成功' : assignmentSubmitStatus === 'cancel' ? "撤销成功" : "保存成功";
        window.vtoast.success(msg);
      },
      resetAssignmentSubmitStatus(assignmentSubmitStatus) {
        if (assignmentSubmitStatus) {
          this.assignment.assignmentSubmitStatus = assignmentSubmitStatus === 'publish' ? assignmentSubmitStatus : null;
        }
      },
      // ---------- <<<<<<<<<<<<< 保存作业 uiAction ----------


      // 更新作业选中的高亮状态
      formItemSelect(index) {
        this.selectedFormItemId = index
      },
      // 生成每个作业的随机id
      uuid(t = 21) {
        let e = "", r = crypto.getRandomValues(new Uint8Array(t));
        for (; t--;) {
          let n = 63 & r[t];
          e += n < 36 ? n.toString(36) : n < 62 ? (n - 26).toString(36).toUpperCase() : n < 63 ? "_" : "-"
        }
        ;
        return e
      },

      updateFormItemList(val) {
        this.assignmentStandardAnswer = val;
      },
    },
    // 使用provide将方法传递给下层所有组件
    // 直接传selectedFormItemId更新group里的内容点击更新不了
    provide() {
      return {
        formItemSelect: this.formItemSelect,
        uuid: this.uuid,
        optionKey: this.optionKey,
      };
    },
  })
</script>

<style scoped>
  @media (max-width: 600px) {
    .sm-hide {
      display: none;
    }

    .sm-pt-2 {
      padding-top: 10px;
    }

    .sm-pl-0 {
      padding-left: 0;
    }
  }

  @media (min-width: 600px) {
    .md-pr-0 {
      padding-right: 0;
    }
  }
</style>
{% endblock %}